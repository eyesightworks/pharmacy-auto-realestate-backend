<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Eyesightworks Admin Portal</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
body{
margin:0;
font-family:'Inter',sans-serif;
background:#0f172a;
color:#fff;
display:flex;
align-items:center;
justify-content:center;
height:100vh;
}

.card{
background:#1e293b;
padding:40px;
border-radius:16px;
width:440px;
max-width:95%;
box-shadow:0 20px 50px rgba(0,0,0,0.4);
}

h1{margin-bottom:8px;}
.subtitle{color:#94a3b8;font-size:14px;margin-bottom:25px;}

input{
width:100%;
padding:12px;
margin-bottom:15px;
border-radius:8px;
border:none;
background:#334155;
color:white;
}

button{
width:100%;
padding:12px;
border:none;
border-radius:8px;
background:#3b82f6;
color:white;
font-weight:600;
cursor:pointer;
margin-bottom:10px;
}

button:hover{background:#2563eb;}
.logout{background:#ef4444;}
.logout:hover{background:#dc2626;}

.dashboard{display:none;}

.user-box{
background:#334155;
padding:12px;
border-radius:8px;
margin-bottom:20px;
font-size:13px;
}

.status{
font-size:12px;
color:#94a3b8;
margin-top:8px;
min-height:18px;
}

.preview{
margin-top:15px;
max-width:100%;
border-radius:8px;
display:none;
}

small{
color:#64748b;
}
</style>
</head>
<body>

<div class="card">

<!-- LOGIN -->
<div id="loginSection">
<h1>Eyesightworks</h1>
<div class="subtitle">Admin Access Only</div>

<input type="email" id="email" placeholder="Admin Email" autocomplete="off">
<input type="password" id="password" placeholder="Password" autocomplete="off">
<button onclick="login()">Login</button>

<small>Authorized administrators only.</small>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboard">
<h1>Admin Dashboard</h1>
<div class="subtitle">Secure Media Management</div>

<div class="user-box" id="userInfo"></div>

<h3>Upload Product Image</h3>
<input type="file" id="imageInput" accept="image/*">
<button onclick="uploadImage()">Upload Image</button>

<div class="status" id="uploadStatus"></div>
<img id="imagePreview" class="preview">

<button class="logout" onclick="logout()">Logout</button>

</div>
</div>

<script>

const API = "https://pharmacy-auto-realestate-backend.onrender.com/api";

// ================= TOKEN HANDLING =================
function saveToken(token){
localStorage.setItem("token",token);
}

function getToken(){
return localStorage.getItem("token");
}

function clearToken(){
localStorage.removeItem("token");
}

function logout(){
clearToken();
location.reload();
}

// ================= LOGIN =================
async function login(){
const email=document.getElementById("email").value.trim();
const password=document.getElementById("password").value.trim();

if(!email || !password){
alert("Enter email and password");
return;
}

try{
const res = await fetch(API+"/auth/login",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({email,password})
});

if(!res.ok) throw new Error();

const data = await res.json();

if(!data.access_token){
throw new Error();
}

saveToken(data.access_token);
showDashboard();

}catch{
alert("Invalid credentials or server error.");
}
}

// ================= JWT PARSE =================
function parseJwt(token){
try{
return JSON.parse(atob(token.split(".")[1]));
}catch{
return null;
}
}

// ================= ROLE PROTECTION =================
function showDashboard(){

const token = getToken();
if(!token){
logout();
return;
}

const payload = parseJwt(token);

if(!payload || payload.role !== "ADMIN"){
alert("Access denied. Admin only.");
logout();
return;
}

document.getElementById("loginSection").style.display="none";
document.getElementById("dashboard").style.display="block";

document.getElementById("userInfo").innerHTML=`
<b>User Info</b><br>
Email: ${payload.email}<br>
Role: ${payload.role}
`;
}

// Auto-login if valid token
if(getToken()){
showDashboard();
}

// ================= IMAGE UPLOAD =================
async function uploadImage(){

const file=document.getElementById("imageInput").files[0];
const status=document.getElementById("uploadStatus");

if(!file){
alert("Select an image");
return;
}

if(!file.type.startsWith("image/")){
alert("Only image files allowed");
return;
}

if(file.size > 5*1024*1024){
alert("Max size is 5MB");
return;
}

try{
status.innerText="Requesting upload authorization...";

// 1️⃣ Request signed upload
const signRes = await fetch(API+"/cloudinary/sign",{
method:"POST",
headers:{
Authorization:"Bearer "+getToken()
}
});

if(!signRes.ok) throw new Error();

const signData = await signRes.json();

status.innerText="Uploading image securely...";

// 2️⃣ Upload to Cloudinary
const formData = new FormData();
formData.append("file",file);
formData.append("api_key",signData.api_key);
formData.append("timestamp",signData.timestamp);
formData.append("signature",signData.signature);

const uploadRes = await fetch(
`https://api.cloudinary.com/v1_1/${signData.cloud_name}/image/upload`,
{
method:"POST",
body:formData
}
);

if(!uploadRes.ok) throw new Error();

const uploadData = await uploadRes.json();

status.innerText="Saving image record...";

// 3️⃣ Save in Neon via backend
await fetch(API+"/images/save",{
method:"POST",
headers:{
"Content-Type":"application/json",
Authorization:"Bearer "+getToken()
},
body:JSON.stringify({
imageUrl: uploadData.secure_url,
public_id: uploadData.public_id
})
});

status.innerText="Upload successful!";
displayImage(uploadData.secure_url);

}catch{
status.innerText="Upload failed.";
}
}

// ================= OPTIMIZED DISPLAY =================
function displayImage(url){

const optimized=url.replace(
"/upload/",
"/upload/w_600,q_auto,f_auto/"
);

const img=document.getElementById("imagePreview");
img.src=optimized;
img.style.display="block";
}

</script>
</body>
</html>